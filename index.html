<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>電商價格追蹤平台</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f7f7f7;
      color: #333;
    }
    h1 { text-align:center; color:#2c3e50; }
    .buttons { text-align:center; margin-bottom:20px; }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background-color: #3498db;
      color:white;
      transition:0.3s;
    }
    button:hover { background-color:#2980b9; }
    table {
      width:100%;
      border-collapse: collapse;
      background-color:white;
      box-shadow:0 0 10px rgba(0,0,0,0.1);
      margin-bottom:30px;
    }
    th,td { padding:10px; border:1px solid #ddd; text-align:center; }
    th { background-color:#3498db; color:white; }
    tbody tr:nth-child(even) { background-color:#f2f2f2; }
    a { color:#3498db; text-decoration:none; }
    a:hover { text-decoration:underline; }
    #loading { text-align:center; font-size:18px; color:#e67e22; display:none; margin-bottom:20px; }
    #chart-container { width:90%; max-width:1000px; margin:0 auto 50px; }
  </style>
</head>
<body>

<h1>電商價格追蹤平台</h1>

<div class="buttons">
  <button onclick="loadPrices('tw')">台灣 (測試資料)</button>
  <button onclick="loadPrices('us')">美國 Amazon (測試資料)</button>
  <button onclick="loadPrices('jp')">日本 Amazon (測試資料)</button>
</div>

<div id="loading">資料載入中，請稍候...</div>

<table id="price-table">
  <thead>
    <tr>
      <th>商品名稱</th>
      <th>價格</th>
      <th>貨幣</th>
      <th>連結</th>
      <th>抓取時間</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="chart-container">
  <canvas id="priceChart"></canvas>
</div>

<!-- Chart.js CDN + 日期 adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2"></script>

<script>
let priceChart;

// 模擬測試資料
const testData = {
  tw: [
    {title:"商品A", price:500, currency:"NTD", url:"#", fetchedAt:"2025-01-01T10:00:00"},
    {title:"商品A", price:520, currency:"NTD", url:"#", fetchedAt:"2025-02-01T10:00:00"},
    {title:"商品B", price:300, currency:"NTD", url:"#", fetchedAt:"2025-01-15T10:00:00"},
    {title:"商品B", price:280, currency:"NTD", url:"#", fetchedAt:"2025-03-01T10:00:00"}
  ],
  us: [
    {title:"Product A", price:50, currency:"USD", url:"#", fetchedAt:"2025-01-01T10:00:00"},
    {title:"Product A", price:48, currency:"USD", url:"#", fetchedAt:"2025-02-01T10:00:00"},
    {title:"Product B", price:30, currency:"USD", url:"#", fetchedAt:"2025-01-15T10:00:00"},
    {title:"Product B", price:32, currency:"USD", url:"#", fetchedAt:"2025-03-01T10:00:00"}
  ],
  jp: [
    {title:"商品X", price:5000, currency:"JPY", url:"#", fetchedAt:"2025-01-01T10:00:00"},
    {title:"商品X", price:4800, currency:"JPY", url:"#", fetchedAt:"2025-02-01T10:00:00"},
    {title:"商品Y", price:3000, currency:"JPY", url:"#", fetchedAt:"2025-01-15T10:00:00"},
    {title:"商品Y", price:3200, currency:"JPY", url:"#", fetchedAt:"2025-03-01T10:00:00"}
  ]
};

function loadPrices(region) {
  const loading = document.getElementById('loading');
  loading.style.display = 'block';

  // 這裡使用測試資料
  const data = testData[region] || [];

  const tbody = document.querySelector('#price-table tbody');
  tbody.innerHTML = '';

  if(data.length === 0){
    tbody.innerHTML = '<tr><td colspan="5">沒有抓到資料</td></tr>';
    loading.style.display = 'none';
    return;
  }

  // 顯示表格
  data.forEach(item=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.title}</td>
      <td>${item.price}</td>
      <td>${item.currency}</td>
      <td><a href="${item.url}" target="_blank">連結</a></td>
      <td>${item.fetchedAt}</td>
    `;
    tbody.appendChild(tr);
  });

  // 顯示折線圖
  generateChart(data);
  loading.style.display = 'none';
}

function generateChart(data){
  const grouped = {};
  data.forEach(item=>{
    if(!grouped[item.title]) grouped[item.title] = [];
    grouped[item.title].push({x: new Date(item.fetchedAt), y: item.price});
  });

  const datasets = Object.keys(grouped).map(title=>({
    label: title,
    data: grouped[title].sort((a,b)=>a.x - b.x),
    borderColor: randomColor(),
    fill:false,
    tension:0.1
  }));

  const ctx = document.getElementById('priceChart').getContext('2d');
  if(priceChart) priceChart.destroy();
  priceChart = new Chart(ctx,{
    type:'line',
    data:{datasets},
    options:{
      responsive:true,
      plugins:{
        title:{display:true,text:'商品價格歷史折線圖'},
        tooltip:{
          mode:'nearest',
          intersect:false,
          callbacks:{
            label:function(context){ return context.dataset.label + ': ' + context.parsed.y; }
          }
        }
      },
      scales:{
        x:{
          type:'time',
          time:{unit:'month',tooltipFormat:'yyyy-MM-dd'},
          title:{display:true,text:'日期'}
        },
        y:{title:{display:true,text:'價格'}}
      }
    }
  });
}

function randomColor(){
  const r = Math.floor(Math.random()*200);
  const g = Math.floor(Math.random()*200);
  const b = Math.floor(Math.random()*200);
  return `rgb(${r},${g},${b})`;
}
</script>

</body>
</html>
