<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>電商價格追蹤平台</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f7f7f7;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    .buttons {
      text-align: center;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background-color: #3498db;
      color: white;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background-color: #3498db;
      color: white;
    }
    tbody tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    a {
      color: #3498db;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    #loading {
      text-align: center;
      font-size: 18px;
      color: #e67e22;
      display: none;
      margin-bottom: 20px;
    }
    #chart-container {
      width: 90%;
      max-width: 1000px;
      margin: 0 auto 50px;
    }
  </style>
</head>
<body>

<h1>電商價格追蹤平台</h1>

<div class="buttons">
  <button onclick="loadPrices('tw')">台灣 (Momo / PChome /蝦皮)</button>
  <button onclick="loadPrices('us')">Amazon 美國</button>
  <button onclick="loadPrices('jp')">Amazon 日本</button>
</div>

<div id="loading">資料載入中，請稍候...</div>

<table id="price-table">
  <thead>
    <tr>
      <th>商品名稱</th>
      <th>價格</th>
      <th>貨幣</th>
      <th>連結</th>
      <th>抓取時間</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="chart-container">
  <canvas id="priceChart"></canvas>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  let priceChart;

  async function loadPrices(region) {
    const loading = document.getElementById('loading');
    loading.style.display = 'block';

    let apiUrl = '';
    // 改成你自己的 Apify dataset API URL
    if (region === 'tw') apiUrl = 'https://api.apify.com/v2/datasets/你的台灣 dataset id/items?clean=1';
    else if (region === 'us') apiUrl = 'https://api.apify.com/v2/datasets/你的美國 Amazon dataset id/items?clean=1';
    else if (region === 'jp') apiUrl = 'https://api.apify.com/v2/datasets/你的日本 Amazon dataset id/items?clean=1';

    try {
      const res = await fetch(apiUrl);
      const data = await res.json();

      const tbody = document.querySelector('#price-table tbody');
      tbody.innerHTML = '';

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">沒有抓到資料</td></tr>';
        loading.style.display = 'none';
        return;
      }

      // 先顯示表格
      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.title || '-'}</td>
          <td>${item.price !== undefined ? item.price : '-'}</td>
          <td>${item.currency || 'NTD'}</td>
          <td><a href="${item.url}" target="_blank">連結</a></td>
          <td>${item.fetchedAt || item.timestamp || '-'}</td>
        `;
        tbody.appendChild(tr);
      });

      // 準備折線圖資料
      generateChart(data);

    } catch (err) {
      console.error('抓取資料失敗', err);
      alert('抓取資料失敗，請確認 Apify dataset 是否公開');
    } finally {
      loading.style.display = 'none';
    }
  }

  function generateChart(data) {
    // 假設 dataset 裡有 title, price, fetchedAt
    // 先按商品分組
    const grouped = {};
    data.forEach(item => {
      if (!item.title || !item.price || !item.fetchedAt) return;
      if (!grouped[item.title]) grouped[item.title] = [];
      grouped[item.title].push({
        date: new Date(item.fetchedAt),
        price: item.price
      });
    });

    const datasets = [];
    Object.keys(grouped).forEach(title => {
      // 按時間排序
      const items = grouped[title].sort((a,b) => a.date - b.date);
      datasets.push({
        label: title,
        data: items.map(i => ({x: i.date, y: i.price})),
        borderColor: randomColor(),
        fill: false,
        tension: 0.1
      });
    });

    const ctx = document.getElementById('priceChart').getContext('2d');
    if (priceChart) priceChart.destroy(); // 先刪掉舊圖
    priceChart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: datasets
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: '商品價格歷史折線圖'
          },
          tooltip: {
            mode: 'nearest',
            intersect: false,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y;
              }
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'day',
              tooltipFormat: 'YYYY-MM-DD'
            },
            title: {
              display: true,
              text: '日期'
            }
          },
          y: {
            title: {
              display: true,
              text: '價格'
            }
          }
        }
      }
    });
  }

  function randomColor() {
    const r = Math.floor(Math.random()*200);
    const g = Math.floor(Math.random()*200);
    const b = Math.floor(Math.random()*200);
    return `rgb(${r},${g},${b})`;
  }
</script>

</body>
</html>
